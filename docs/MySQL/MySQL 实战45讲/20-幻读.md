幻读

### 幻读

**幻读**指的是一个事务在前后两次查询同一个范围的时候，后一次查询看到了前一次查询没有看到的行。

- 幻读在“当前读”下才会出现；
- 幻读仅专指“新插入的行”。

**幻读会出现的问题：**

- 语义的问题；
- 数据一致性问题；



解决方案：

产生幻读的原因是，行锁只能锁住行，但是新插入记录这个动作，要更新的是记录之间的“间隙”。因此，为了解决幻读问题，InnoDB只好引入新的锁，也就是间隙锁(Gap Lock)。

![image-20210429161932136](assets/image-20210429161932136.png)



间隙锁和行锁合称**next-key lock**，每个**next-key lock是前开后闭区间**。

**间隙锁和 next-key lock 的引入，帮我们解决了幻读的问题，但同时也带来了一些“困扰”。**





```sql
CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  `d` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c` (`c`) // 普通索引
) ENGINE=InnoDB;

insert into t values(0,0,0),(5,5,5),
(10,10,10),(15,15,15),(20,20,20),(25,25,25);
```



